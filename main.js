/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin-
*/

var A=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var I=(m,n)=>{for(var e in n)A(m,e,{get:n[e],enumerable:!0})},B=(m,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of R(n))!U.call(m,i)&&i!==e&&A(m,i,{get:()=>n[i],enumerable:!(t=$(n,i))||t.enumerable});return m};var N=m=>B(A({},"__esModule",{value:!0}),m);var O={};I(O,{default:()=>k});module.exports=N(O);var b=require("obsidian");var w={preset:"grid",imageProperty:"cover",imageHeight:"200px",imageFit:"cover",properties:"all",exclude:[],scrollableProperties:!1,contentHeight:"200px",showLabels:!0,cardSpacing:16,enableShadows:!0,propertiesAlign:"left",titleAlign:"left",fontSize:"default",defaultDateFormat:"YYYY-MM-DD",propertyFormatters:{},mobileColumns:1,mobilePreset:"grid",mobileImageHeight:"150px",mobileScrollableProperties:!0,mobileContentHeight:"150px",forceMobileMode:!1,enableLazyLoading:!1,enableDynamicUpdates:!1,debugMode:!1};var h=require("obsidian"),D=class extends h.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"DataCards Settings"}),e.createEl("h3",{text:"Preset Settings"}),new h.Setting(e).setName("Default Preset").setDesc("Choose the default preset for cards").addDropdown(i=>i.addOption("grid","Grid (balanced, 3 columns)").addOption("portrait","Portrait (optimized for book covers, 3 columns)").addOption("square","Square (1:1 cards with minimal text, 4 columns)").addOption("compact","Compact (side-by-side layout, 4 columns)").addOption("dense","Dense (maximum density, 6 columns)").setValue(this.plugin.settings.preset).onChange(async a=>{this.plugin.settings.preset=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Image Settings"}),new h.Setting(e).setName("Default Image Property").setDesc("The frontmatter property to use for images").addText(i=>i.setPlaceholder("cover").setValue(this.plugin.settings.imageProperty).onChange(async a=>{this.plugin.settings.imageProperty=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Display Settings"}),new h.Setting(e).setName("Show Property Labels").setDesc("Show labels for properties").addToggle(i=>i.setValue(this.plugin.settings.showLabels).onChange(async a=>{this.plugin.settings.showLabels=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Card Spacing").setDesc("Space between cards (in pixels)").addSlider(i=>i.setLimits(0,32,4).setValue(this.plugin.settings.cardSpacing).setDynamicTooltip().onChange(async a=>{this.plugin.settings.cardSpacing=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Enable Card Shadows").setDesc("Add subtle shadows to cards for a more three-dimensional appearance").addToggle(i=>i.setValue(this.plugin.settings.enableShadows).onChange(async a=>{this.plugin.settings.enableShadows=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Properties Alignment").setDesc("Text alignment for properties and their labels").addDropdown(i=>i.addOption("left","Left").addOption("center","Center").addOption("right","Right").setValue(this.plugin.settings.propertiesAlign).onChange(async a=>{this.plugin.settings.propertiesAlign=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Title Alignment").setDesc("Text alignment for the title (filename)").addDropdown(i=>i.addOption("left","Left").addOption("center","Center").addOption("right","Right").setValue(this.plugin.settings.titleAlign).onChange(async a=>{this.plugin.settings.titleAlign=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Font Size").setDesc("Text size for all card elements (properties, labels, and title)").addDropdown(i=>i.addOption("larger","Larger (120%)").addOption("large","Large (110%)").addOption("default","Default (100%)").addOption("small","Small (90% - similar to dense preset)").addOption("smaller","Smaller (80%)").setValue(this.plugin.settings.fontSize).onChange(async a=>{this.plugin.settings.fontSize=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Card Content Settings"}),new h.Setting(e).setName("Scrollable Properties").setDesc("Enable scrolling for card properties when they exceed the content height (Note: Square and Compact presets are scrollable by default)").addToggle(i=>i.setValue(this.plugin.settings.scrollableProperties).onChange(async a=>{this.plugin.settings.scrollableProperties=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Content Height").setDesc("Height of the scrollable content area (e.g., 200px)").addText(i=>i.setPlaceholder("200px").setValue(this.plugin.settings.contentHeight).onChange(async a=>{this.plugin.settings.contentHeight=a||"200px",await this.plugin.saveSettings()})),e.createEl("h3",{text:"Formatting Settings"}),new h.Setting(e).setName("Default Date Format").setDesc("Format for displaying dates (YYYY = year, MM = month, DD = day)").addText(i=>i.setPlaceholder("YYYY-MM-DD").setValue(this.plugin.settings.defaultDateFormat).onChange(async a=>{this.plugin.settings.defaultDateFormat=a||"YYYY-MM-DD",await this.plugin.saveSettings()})),e.createEl("h3",{text:"Mobile Settings"}),new h.Setting(e).setName("Mobile Preset").setDesc("Preset to use on mobile devices (all presets default to 1 column on mobile)").addDropdown(i=>i.addOption("grid","Grid (balanced)").addOption("portrait","Portrait (optimized for book covers)").addOption("square","Square (1:1 cards with minimal text)").addOption("compact","Compact (side-by-side layout)").addOption("dense","Dense (maximum density)").setValue(this.plugin.settings.mobilePreset).onChange(async a=>{this.plugin.settings.mobilePreset=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Mobile Scrollable Properties").setDesc("Enable scrolling for card properties on mobile devices").addToggle(i=>i.setValue(this.plugin.settings.mobileScrollableProperties).onChange(async a=>{this.plugin.settings.mobileScrollableProperties=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Mobile Content Height").setDesc("Height of the scrollable content area on mobile devices").addText(i=>i.setPlaceholder("150px").setValue(this.plugin.settings.mobileContentHeight).onChange(async a=>{this.plugin.settings.mobileContentHeight=a||"150px",await this.plugin.saveSettings()})),new h.Setting(e).setName("Force Mobile Mode").setDesc("Force the plugin to use mobile settings even on desktop (for testing)").addToggle(i=>i.setValue(this.plugin.settings.forceMobileMode).onChange(async a=>{this.plugin.settings.forceMobileMode=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Performance Settings"}),new h.Setting(e).setName("Enable Lazy Loading").setDesc("Only load images when they become visible (improves performance with many cards)").addToggle(i=>i.setValue(this.plugin.settings.enableLazyLoading).onChange(async a=>{this.plugin.settings.enableLazyLoading=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Update Settings"}),new h.Setting(e).setName("Enable Dynamic Updates").setDesc("Automatically update DataCards when properties change (may impact performance)").addToggle(i=>i.setValue(this.plugin.settings.enableDynamicUpdates).onChange(async a=>{this.plugin.settings.enableDynamicUpdates=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("Per-Card Dynamic Updates").setDesc('Individual cards can override the global setting with "dynamicUpdate: true/false" in their settings').setDisabled(!0),e.createEl("h3",{text:"Developer Settings"}),new h.Setting(e).setName("Debug Mode").setDesc("Enable debug logging (only use during development or troubleshooting)").addToggle(i=>i.setValue(this.plugin.settings.debugMode).onChange(async a=>{this.plugin.settings.debugMode=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Help"});let t=e.createEl("div");t.innerHTML=`
      <p><strong>Basic Usage:</strong><br>
      Use the <code>datacards</code> code block to create card layouts from Dataview queries.</p>
      
      <p><strong>Example:</strong></p>
      <pre><code>
\`\`\`datacards
TABLE title, author, rating, cover FROM #books
SORT rating DESC

// Settings
preset: grid
imageFit: contain
defaultDateFormat: YYYY
\`\`\`
      </code></pre>
      
      <p><strong>Important:</strong> You must explicitly include all properties you want to display in your Dataview query (including the image property).</p>
      
      <p><strong>Image Support:</strong><br>
      The plugin supports external URLs, vault images, and wiki links:<br>
      <code>cover: https://example.com/image.jpg</code> or <code>cover: [[path/to/image.jpg]]</code></p>     
    
      <p><strong>Tip:</strong> Data Cards works best with the Editor-Setting "Readable line length" disabled. </p><br>
      
      <p><a href="https://github.com/Sophokles187/data-cards" target="_blank" rel="noopener">View complete documentation and examples on GitHub</a></p>
    `}};var s=class{static setDebugMode(n){this.debugMode=n}static error(n,...e){console.error(`[DataCards] ${n}`,...e)}static warn(n,...e){console.warn(`[DataCards] ${n}`,...e)}static debug(n,...e){this.debugMode&&console.log(`[DataCards] ${n}`,...e)}};s.debugMode=!1;var E=class{parseDataCardsBlock(n){s.debug("Parsing datacards block");let e=/\n-{3,}\n|\n\/\/\s*Settings.*|\n\/\*\s*Settings\s*\*\/.*/,t=n.match(e),i=/^\/\/\s*Settings.*/,a=n.match(i),r,o;t&&t.index!==void 0?(s.debug("Found settings separator at index:",t.index),r=n.substring(0,t.index).trim(),o=n.substring(t.index+t[0].length).trim()):a?(s.debug("Block starts with settings marker"),r="",o=n.substring(a[0].length).trim()):(s.debug("No settings separator found"),r=n.trim(),o=""),s.debug("Extracted query:",r),r=this.ensureQueryType(r);let l=this.parseSettings(o),d=this.extractColumnAliases(r);return d.length>0&&(l.columnAliases=d,s.debug("Extracted column aliases:",d)),{query:r,settings:l}}extractColumnAliases(n){let e=[];if(!n.trim().toUpperCase().startsWith("TABLE"))return e;try{let t=n.match(/TABLE\s+(without\s+id\s+)?([\s\S]*?)(?:\s+FROM|\s+WHERE|\s+SORT|\s+GROUP BY|\s+LIMIT|\s+FLATTEN|$)/i);if(!t||!t[2])return e;let i=t[2].trim();if(s.debug("Extracted columns text:",i),!i)return e;let a=this.splitColumnsPreservingExpressions(i);for(let r of a){let o=r.match(/^(.*?)\s+as\s+(?:"([^"]+)"|'([^']+)'|([^\s,]+))$/i);if(o){let l=o[1].trim(),d=o[2]||o[3]||o[4],c=l;if(/^[a-zA-Z0-9_.-]+$/.test(l))c=l;else{let g=l.match(/\(\s*".*?"\s*\+\s*([a-zA-Z0-9_.-]+)\s*\+\s*".*?"\s*\)/);g&&g[1]&&(c=g[1],s.debug(`Extracted field name from complex expression: ${c}`))}e.push({original:c,alias:d,expression:l}),s.debug(`Found column alias: ${c} as "${d}"`)}}}catch(t){s.error("Error extracting column aliases:",t)}return e}splitColumnsPreservingExpressions(n){let e=[],t="",i=0,a=!1,r=!1;for(let o=0;o<n.length;o++){let l=n[o];if(l==='"'&&!r?a=!a:l==="'"&&!a&&(r=!r),!a&&!r&&(l==="("?i++:l===")"&&i--),l===","&&i===0&&!a&&!r){e.push(t.trim()),t="";continue}t+=l}return t.trim()&&e.push(t.trim()),e}ensureQueryType(n){if(!/\b(TABLE|LIST|TASK|CALENDAR)\b/i.test(n)){let t=n.split(`
`),i=-1;for(let a=0;a<t.length;a++){let r=t[a].trim();if(r&&!r.startsWith("//")&&!r.startsWith("/*")){i=a;break}}if(i>=0){let a=this.parseSettings(t.slice(i+1).join(`
`)),r="",o=[];return a.imageProperty&&o.push(a.imageProperty),r="",s.debug("Using simple TABLE query without property list"),r.trim()===""?t[i]="TABLE "+t[i]:t[i]="TABLE"+r+" "+t[i],t.join(`
`)}else return"TABLE "+n}return n}parseSettings(n){if(!n)return{};let e={},t=n.split(`
`);s.debug("Parsing settings from text");for(let i of t){if(i.trim().startsWith("//")||i.trim().startsWith("/*")||!i.trim())continue;let a=i.match(/^\s*([a-zA-Z0-9_]+)\s*:\s*(.+)\s*$/);if(a){let[,r,o]=a;if(s.debug(`Found setting: ${r} = ${o}`),r==="properties"&&o.trim().startsWith("[")&&o.trim().endsWith("]")){s.debug("Detected properties array");let l=o.substring(1,o.length-1).trim();if(l){let d=l.split(",").map(c=>c.trim());e[r]=d}else e[r]=[]}else r==="defaultDateFormat"?e[r]=o.trim():r==="dynamicUpdate"?(e[r]=this.parseValue(o.trim()),s.debug(`Parsed dynamicUpdate setting: ${e[r]}`)):e[r]=this.parseValue(o.trim())}}return e}parseValue(n){s.debug("Parsing value:",n);try{return JSON.parse(n)}catch(e){}if(n.startsWith("[")&&n.endsWith("]")){s.debug("Detected array syntax");let e=n.substring(1,n.length-1).trim();return e?e.split(",").map(i=>i.trim()):[]}return/^-?\d+(\.\d+)?$/.test(n)?Number(n):n.toLowerCase()==="true"?!0:n.toLowerCase()==="false"?!1:n}};var F=require("obsidian");var C=class{constructor(n,e){this.currentSettings=null;this.app=n,this.pluginSettings=e}updateSettings(n){this.pluginSettings=n}isMobileDevice(){return F.Platform.isMobile||this.pluginSettings.forceMobileMode}renderCards(n,e,t){let i=this.isMobileDevice();s.debug("Is mobile device:",i);let a={...this.pluginSettings};s.debug("Initial settings from plugin:",{preset:a.preset,imageHeight:a.imageHeight,mobileColumns:a.mobileColumns,mobilePreset:a.mobilePreset,mobileImageHeight:a.mobileImageHeight}),a={...a,...t},s.debug("After applying block settings:",{preset:a.preset,imageHeight:a.imageHeight,mobileColumns:a.mobileColumns,mobilePreset:a.mobilePreset,mobileImageHeight:a.mobileImageHeight}),i&&(s.debug("Applying mobile settings..."),s.debug(`Using mobile columns: ${a.mobileColumns}`),a.mobilePreset!==void 0&&(s.debug(`Overriding preset: ${a.preset} with mobilePreset: ${a.mobilePreset}`),a.preset=a.mobilePreset),a.mobileImageHeight!==void 0&&(s.debug(`Overriding imageHeight: ${a.imageHeight} with mobileImageHeight: ${a.mobileImageHeight}`),a.imageHeight=a.mobileImageHeight),s.debug("Final settings after applying mobile settings:",{preset:a.preset,imageHeight:a.imageHeight})),this.currentSettings=a;let r=n.createEl("div",{cls:"datacards-container"});r.addClass(`datacards-preset-${a.preset}`),a.enableShadows||r.addClass("datacards-no-shadows"),a.fontSize&&a.fontSize!=="default"?(r.addClass(`datacards-font-${a.fontSize}`),s.debug(`Applied font size class: datacards-font-${a.fontSize}`)):a.preset==="dense"&&(!a.fontSize||a.fontSize==="default")&&(r.addClass("datacards-font-small"),s.debug("Applied small font size for dense preset")),r.style.setProperty("--card-gap",`${a.cardSpacing}px`);let o;if(i)o=a.mobileColumns;else{let d=3;a.preset==="dense"?d=6:a.preset==="compact"||a.preset==="square"?d=4:a.preset==="portrait"&&(d=3),o=t.columns!==void 0?t.columns:d}s.debug(`Using ${o} columns`),r.style.setProperty("--card-columns",o.toString(),"important");let l;if(t.imageHeight!==void 0?l=a.imageHeight:a.preset==="portrait"?l="350px":a.preset==="square"||a.preset==="compact"?l="200px":a.preset==="dense"?l="120px":l="200px",(typeof l=="number"||/^\d+$/.test(l))&&(l=`${l}px`),r.style.setProperty("--image-height",l),t.imageFit!==void 0)r.style.setProperty("--image-fit",a.imageFit);else{let d=a.preset==="portrait"?"contain":"cover";r.style.setProperty("--image-fit",d)}e&&e.values&&Array.isArray(e.values)?(s.debug("Detected table-like results with values array"),this.renderTableResults(r,e,a)):e&&Array.isArray(e)?(s.debug("Detected array results"),this.renderArrayResults(r,e,a)):e&&typeof e=="object"?(s.debug("Detected object results"),this.renderObjectResults(r,e,a)):(s.debug("No valid results detected"),this.renderError(r,"No results or unsupported result type"))}renderError(n,e){let t=n.createEl("div",{cls:"datacards-error",text:e})}renderTableResults(n,e,t){let{values:i,headers:a}=e;s.debug("Rendering table results:"),s.debug("- Headers:",a),s.debug("- Number of rows:",i.length),i.forEach((r,o)=>{s.debug(`Processing row ${o}`);let l=this.createCardElement(n);if(t.imageProperty&&a.includes(t.imageProperty)){let u=a.indexOf(t.imageProperty),y=r[u];s.debug(`Image property '${t.imageProperty}' value:`,y),y&&this.addImageToCard(l,y)}else t.imageProperty&&s.debug(`Image property '${t.imageProperty}' not found in headers:`,a);let d=l.createEl("div",{cls:"datacards-content"});if(a.includes("File")||a.includes("file")){let u=a.findIndex(y=>y.toLowerCase()==="file");if(u>=0){let y=r[u];s.debug("File property value:",y);let f=d.createEl("div",{cls:"datacards-property datacards-file-property-container"});this.formatFileProperty(f,y)}}let c=d.createEl("div",{cls:"datacards-properties-container"});if(this.shouldUseScrollableProperties(t)){c.addClass("datacards-scrollable-properties");let u=this.getContentHeight(t);c.style.setProperty("--content-height",u)}let p=[];t.properties==="all"?(p=[...a],s.debug("Using all headers as properties:",p)):Array.isArray(t.properties)?(p=[...t.properties],s.debug("Using specified properties:",p)):s.debug("No properties specified, using empty array");let v=p.filter(u=>!t.exclude.includes(u)&&u!==t.imageProperty&&u.toLowerCase()!=="file");s.debug("Filtered properties (after excluding file):",v),v.forEach(u=>{if(s.debug(`Checking property '${u}' in headers:`,a.includes(u)),a.includes(u)){let y=a.indexOf(u),f=r[y];if(console.log(`Property '${u}' value:`,f),console.log(`Property '${u}' type:`,typeof f),typeof f=="string"&&f.includes("[[")&&f.includes("]]")){console.log(`Found wiki link in property '${u}':`,f);let P=c.createEl("div",{cls:"datacards-property"});t.showLabels&&P.createEl("div",{cls:"datacards-property-label",text:u});let M=P.createEl("div",{cls:"datacards-property-value"}),T=f.match(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/);if(T){let x=T[1],L=T[2]||this.getCleanFilename(x);console.log(`Creating direct link for wiki link: path="${x}", display="${L}"`);let H=M.createEl("a",{cls:"internal-link",text:L,attr:{href:x,"data-href":x,"data-type":"link"}});this.app.workspace.trigger("hover-link",{event:new MouseEvent("mouseover"),source:"preview",hoverEl:H,targetEl:H,linktext:x})}else M.setText(f)}else this.addPropertyToCard(c,u,f,t)}else s.debug(`Property '${u}' not found in headers`)}),v.length===0&&!a.some(u=>u.toLowerCase()==="file")&&(s.debug("No properties were added to the card"),d.createEl("div",{cls:"datacards-property",text:"No properties to display"}))})}renderArrayResults(n,e,t){e.forEach(i=>{let a=this.createCardElement(n);t.imageProperty&&i[t.imageProperty]&&this.addImageToCard(a,i[t.imageProperty]);let r=a.createEl("div",{cls:"datacards-content"});if("file"in i){let p=r.createEl("div",{cls:"datacards-property datacards-file-property-container"});this.formatFileProperty(p,i.file)}let o=r.createEl("div",{cls:"datacards-properties-container"});if(this.shouldUseScrollableProperties(t)){o.addClass("datacards-scrollable-properties");let p=this.getContentHeight(t);o.style.setProperty("--content-height",p)}let d=Object.keys(i);(t.properties==="all"?d:Array.isArray(t.properties)?t.properties:[]).filter(p=>!t.exclude.includes(p)&&p!==t.imageProperty&&p.toLowerCase()!=="file").forEach(p=>{p in i&&this.addPropertyToCard(o,p,i[p],t)})})}renderObjectResults(n,e,t){let i=this.createCardElement(n);t.imageProperty&&e[t.imageProperty]&&this.addImageToCard(i,e[t.imageProperty]);let a=i.createEl("div",{cls:"datacards-content"});if("file"in e){let g=a.createEl("div",{cls:"datacards-property datacards-file-property-container"});this.formatFileProperty(g,e.file)}let r=a.createEl("div",{cls:"datacards-properties-container"});if(this.shouldUseScrollableProperties(t)){r.addClass("datacards-scrollable-properties");let g=this.getContentHeight(t);r.style.setProperty("--content-height",g)}let l=Object.keys(e);(t.properties==="all"?l:Array.isArray(t.properties)?t.properties:[]).filter(g=>!t.exclude.includes(g)&&g!==t.imageProperty&&g.toLowerCase()!=="file").forEach(g=>{g in e&&this.addPropertyToCard(r,g,e[g],t)})}createCardElement(n){return n.createEl("div",{cls:"datacards-card"})}addImageToCard(n,e){var r;let t=n.createEl("div",{cls:"datacards-image-container"}),i;typeof e=="object"&&e!==null?(s.debug("Image value is an object:",e),"path"in e?(i=e.path,s.debug("Extracted path from Link object:",i)):(i=String(e),s.debug("Converted object to string:",i))):(i=String(e),s.debug("Image value is a string:",i)),i=this.extractImageSource(i),s.debug("After image source extraction:",i);let a=t.createEl("div",{cls:"datacards-image-placeholder",text:"Loading image..."});(r=this.currentSettings)!=null&&r.enableLazyLoading?this.lazyLoadImage(t,a,i):this.loadImage(t,a,i)}extractImageSource(n){if(!n||typeof n!="string")return String(n||"");let e=n.match(/!\[(.*?)\]\((.*?)\)/);if(e){let a=e[2];return s.debug("Extracted URL from markdown image syntax:",a),a.replace(/['",.;:]+$/,"")}let t=n.match(/\[\[(.*?)\]\]/);if(t){let a=`[[${t[1]}]]`;return s.debug("Extracted wiki link:",a),a}let i=n.match(/(https?:\/\/[^\s"'<>[\]{}]+)/);if(i){let a=i[1];return s.debug("Extracted URL:",a),a.replace(/['",.;:]+$/,"")}return n}lazyLoadImage(n,e,t){s.debug("Lazy loading image:",t),new IntersectionObserver((a,r)=>{a.forEach(o=>{o.isIntersecting&&(s.debug("Image container is now visible, loading image:",t),this.loadImage(n,e,t),r.disconnect())})},{rootMargin:"100px",threshold:.1}).observe(n)}loadImage(n,e,t){let i=t.match(/!\[(.*?)\]\((.*?)\)/);if(i){let a=i[2];s.debug("Extracted URL from markdown image syntax:",a),this.loadImage(n,e,a);return}if(t.startsWith("http")||t.startsWith("https")){s.debug("Handling as external URL:",t);let a=t.replace(/['",.;:]+$/,"");s.debug("Cleaned URL:",a),this.loadExternalImage(n,e,a)}else if(t.startsWith("[[")&&t.endsWith("]]")){s.debug("Handling as wiki link");let a=t.substring(2,t.length-2),r=a;a.includes("|")&&(r=a.split("|")[0]);try{let o=this.app.vault.getAbstractFileByPath(r);if(o&&"stat"in o){s.debug("Found file in vault:",o);let l=o,d=this.app.vault.getResourcePath(l);s.debug("Resource path:",d);let c=n.createEl("img",{cls:"datacards-image",attr:{src:d}});c.onload=()=>{e.remove(),c.addClass("loaded")},c.onerror=()=>{e.setText("Image not found")}}else s.debug("File not found in vault or not a file:",r),e.setText("Image not found")}catch(o){s.error("Error loading image:",o),e.setText("Error loading image")}}else{s.debug("Handling as local path");try{let a=this.app.vault.getAbstractFileByPath(t);if(a&&"stat"in a){s.debug("Found file in vault:",a);let r=a,o=this.app.vault.getResourcePath(r);s.debug("Resource path:",o);let l=n.createEl("img",{cls:"datacards-image",attr:{src:o}});l.onload=()=>{e.remove(),l.addClass("loaded")},l.onerror=()=>{e.setText("Image not found")}}else s.debug("File not found in vault:",t),e.setText("Image not found")}catch(a){s.error("Error loading image:",a),e.setText("Error loading image")}}}loadExternalImage(n,e,t){s.debug("Loading external image with URL:",t);let i=n.createEl("img",{cls:"datacards-image",attr:{src:t,crossorigin:"anonymous"}});i.onload=()=>{s.debug("External image loaded successfully:",t),e.remove(),i.addClass("loaded")},i.onerror=a=>{s.error("Failed to load external image with crossorigin attribute:",t,a),s.debug("Trying again without crossorigin attribute"),i.removeAttribute("crossorigin"),i.onload=()=>{s.debug("External image loaded successfully without crossorigin:",t),e.remove(),i.addClass("loaded")},i.onerror=r=>{s.error("Failed to load external image without crossorigin:",t,r);let o=`https://images.weserv.nl/?url=${encodeURIComponent(t)}`;s.debug("Trying with image proxy service:",o),i.src=o,i.onload=()=>{s.debug("External image loaded successfully via proxy:",o),e.remove(),i.addClass("loaded")},i.onerror=l=>{s.error("All attempts to load image failed:",t,l),e.setText("Image not found - URL: "+t);try{let d=document.createElement("img");d.style.display="none",d.src=t,document.body.appendChild(d),setTimeout(()=>{document.body.contains(d)&&document.body.removeChild(d)},3e3)}catch(d){s.error("Error during final test:",d)}}}}}addPropertyToCard(n,e,t,i){s.debug(`Adding property to card: ${e} = ${t}`),s.debug(`Property type: ${typeof t}`);let a=n.createEl("div",{cls:"datacards-property"});i.propertiesAlign&&a.addClass(`datacards-text-${i.propertiesAlign}`);let r=e;if(i.columnAliases){let o=i.columnAliases.find(l=>l.original===e);o&&(r=o.alias,s.debug(`Using alias "${r}" for property "${e}"`))}if(i.showLabels){let o=a.createEl("div",{cls:"datacards-property-label",text:r});i.propertiesAlign&&o.addClass(`datacards-text-${i.propertiesAlign}`)}if(e.toLowerCase()==="file")this.formatFileProperty(a,t);else{let o=i.propertyFormatters[e];o?this.formatPropertyWithCustomFormatter(a,t,o):this.formatPropertyByType(a,t)}}formatPropertyWithCustomFormatter(n,e,t){let i=n.createEl("div",{cls:"datacards-property-value"});switch(t.type){case"stars":this.formatAsStars(i,e,t.options);break;case"badge":this.formatAsBadge(i,e,t.options);break;case"progress":this.formatAsProgress(i,e,t.options);break;case"date":this.formatAsDate(i,e,t.options);break;case"tags":this.formatAsTags(i,e,t.options);break;default:i.setText(String(e))}}formatPropertyByType(n,e){s.debug("formatPropertyByType called with value:",e),s.debug("Value type:",typeof e),typeof e=="string"&&(s.debug("String value length:",e.length),s.debug("String value exact content:",JSON.stringify(e)));let t=n.createEl("div",{cls:"datacards-property-value"});if(n.hasClass("datacards-text-left")?t.addClass("datacards-text-left"):n.hasClass("datacards-text-center")?t.addClass("datacards-text-center"):n.hasClass("datacards-text-right")&&t.addClass("datacards-text-right"),e==null)t.setText("");else if(Array.isArray(e))t.setText(e.join(", "));else if(typeof e=="boolean"){let i=t.createEl("input",{attr:{type:"checkbox",checked:e?"checked":"",disabled:"disabled"}})}else if(typeof e=="number")t.setText(e.toString());else if(e instanceof Date)this.formatAsDate(t,e);else if(typeof e=="string"){if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}[+-]\d{2}:\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}$/.test(e)){let o=new Date(e);if(!isNaN(o.getTime())){this.formatAsDate(t,o);return}}let a=this.extractImageSource(e);if(a!==e){this.formatPropertyByType(n,a);return}if(typeof e=="string"&&e.includes("[[")&&e.includes("|")&&e.includes("]]")){let o=e.match(/\[\[.*\|(.*?)\]\]/);if(o&&o[1]){t.setText(o[1]);return}}if(e.includes("[[")&&e.includes("]]")){console.log("DATACARDS DEBUG: Found wiki link in property value:",e),s.debug("Found wiki link in property value:",e);let o=/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/,l=e.match(o);if(l){console.log("DATACARDS DEBUG: Wiki link match:",l),s.debug("Wiki link match:",l);let d=l[1],c=l[2]||this.getCleanFilename(d);console.log(`DATACARDS DEBUG: Wiki link path: "${d}", display text: "${c}"`),s.debug(`Wiki link path: "${d}", display text: "${c}"`),console.log("DATACARDS DEBUG: Creating link element for wiki link");let g=t.createEl("a",{cls:"internal-link datacards-file-link",text:c,attr:{href:d,"data-href":d,"data-type":"link"}});console.log("DATACARDS DEBUG: Link element created:",g),this.app.workspace.trigger("hover-link",{event:new MouseEvent("mouseover"),source:"preview",hoverEl:g,targetEl:g,linktext:d});return}}let r=e.match(/!\[(.*?)\]\((.*?)\)/);if(r){s.debug("Found markdown image in property value");let o=r[2],l=r[1];t.addClass("loading");let d=t.createEl("img",{cls:"datacards-property-image loading",attr:{src:o,alt:l||"Image",crossorigin:"anonymous"}});d.onload=()=>{s.debug("Property image loaded successfully:",o),d.removeClass("loading")},d.onerror=()=>{s.error("Failed to load property image:",o),d.remove(),t.removeClass("loading"),t.addClass("image-error"),t.setText("Image not found: "+o)};return}if(e.startsWith("[[")&&e.endsWith("]]")){console.log("DATACARDS DEBUG: Processing wiki link that starts and ends with [[]]:",e),s.debug("Processing wiki link that starts and ends with [[]]:",e);let o=/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/,l=e.match(o);if(l){let d=l[1],c=l[2]||this.getCleanFilename(d);console.log(`DATACARDS DEBUG: Wiki link path: "${d}", display text: "${c}"`),s.debug(`Wiki link path: "${d}", display text: "${c}"`),console.log("DATACARDS DEBUG: Creating link element for wiki link (direct match)");let g=t.createEl("a",{cls:"internal-link datacards-file-link",text:c,attr:{href:d,"data-href":d,"data-type":"link"}});console.log("DATACARDS DEBUG: Link element created (direct match):",g),this.app.workspace.trigger("hover-link",{event:new MouseEvent("mouseover"),source:"preview",hoverEl:g,targetEl:g,linktext:d})}else{let d=e.substring(2,e.length-2),c=d,g=d;if(d.includes("|")){let v=d.split("|");g=v[0],c=v[1]}else c=this.getCleanFilename(g);s.debug(`Fallback wiki link path: "${g}", display text: "${c}"`);let p=t.createEl("a",{cls:"internal-link datacards-file-link",text:c,attr:{href:g,"data-href":g,"data-type":"link"}});this.app.workspace.trigger("hover-link",{event:new MouseEvent("mouseover"),source:"preview",hoverEl:p,targetEl:p,linktext:g})}}else if(e.startsWith("#")){let o=t.createEl("a",{cls:"datacards-tag tag-link",text:e,attr:{href:e,"data-href":e,"data-type":"tag"}})}else/<[ubia]>|<\/[ubia]>|<span|<div|<p>|<\/p>|<br>|<hr>/.test(e)?(console.log("DATACARDS DEBUG: Rendering HTML content:",e),t.innerHTML=e):t.setText(e)}else if(typeof e=="object"&&e!==null){if("path"in e&&"type"in e&&e.type==="file"){console.log("Handling Dataview Link object:",e);let i=e.path,a=e.display||this.getCleanFilename(i);console.log(`Creating link from Dataview Link object: path="${i}", display="${a}"`);let r=t.createEl("a",{cls:"internal-link",text:a,attr:{href:i,"data-href":i,"data-type":"link"}});this.app.workspace.trigger("hover-link",{event:new MouseEvent("mouseover"),source:"preview",hoverEl:r,targetEl:r,linktext:i});return}if("ts"in e&&typeof e.ts=="number"){let i=new Date(e.ts);if(!isNaN(i.getTime())){this.formatAsDate(t,i);return}}t.setText(String(e))}else t.setText(String(e))}formatAsStars(n,e,t){let i=(t==null?void 0:t.max)||5,a="\u2605",r="\u2606",o=n.createEl("div",{cls:"datacards-stars"}),l=Math.min(Math.max(0,e),i);for(let d=0;d<l;d++)o.createEl("span",{cls:"datacards-star datacards-star-full",text:a});for(let d=l;d<i;d++)o.createEl("span",{cls:"datacards-star datacards-star-empty",text:r})}formatAsBadge(n,e,t){let i=n.createEl("span",{cls:"datacards-badge",text:e});t!=null&&t.color&&(i.style.backgroundColor=t.color)}formatAsProgress(n,e,t){let i=(t==null?void 0:t.max)||100,a=Math.min(Math.max(0,e),i)/i*100,r=n.createEl("div",{cls:"datacards-progress-container"}),o=r.createEl("div",{cls:"datacards-progress-bar"});o.style.width=`${a}%`,t!=null&&t.showText&&r.createEl("span",{cls:"datacards-progress-text",text:`${Math.round(a)}%`})}formatAsDate(n,e,t){let i=typeof e=="string"?new Date(e):e;if(isNaN(i.getTime())){n.setText(String(e));return}let a=(t==null?void 0:t.format)||(this.currentSettings?this.currentSettings.defaultDateFormat:w.defaultDateFormat),r=i.getFullYear(),o=(i.getMonth()+1).toString().padStart(2,"0"),l=i.getDate().toString().padStart(2,"0"),d=a.replace("YYYY",r.toString()).replace("MM",o).replace("DD",l);n.setText(d)}formatFileProperty(n,e){var a;let t=n.createEl("div",{cls:"datacards-property-value datacards-file-property"});if((a=this.currentSettings)!=null&&a.titleAlign?t.addClass(`datacards-text-${this.currentSettings.titleAlign}`):n.hasClass("datacards-text-left")?t.addClass("datacards-text-left"):n.hasClass("datacards-text-center")?t.addClass("datacards-text-center"):n.hasClass("datacards-text-right")&&t.addClass("datacards-text-right"),e==null){t.setText("");return}let i;if(typeof e=="object"&&e!==null?"path"in e?i=e.path:"link"in e?i=e.link:i=String(e):i=String(e),i=this.extractImageSource(i),s.debug("File property after image source extraction:",i),typeof e=="string"&&e.includes("[[")&&e.includes("|")&&e.includes("]]")){console.log("DATACARDS DEBUG: Found wiki link with pipe character:",e);let r=e.match(/\[\[.*\|(.*?)\]\]/);if(r&&r[1]){console.log("DATACARDS DEBUG: Extracted display text:",r[1]);let o=e.match(/\[\[(.*?)\|(.*?)\]\]/);if(o){let l=o[1],d=o[2];console.log(`DATACARDS DEBUG: Creating link from pipe syntax - path: "${l}", display: "${d}"`);let c=t.createEl("a",{cls:"internal-link datacards-file-link",text:d,attr:{href:l,"data-href":l,"data-type":"link"}});console.log("DATACARDS DEBUG: Created link element for pipe syntax:",c),this.app.workspace.trigger("hover-link",{event:new MouseEvent("mouseover"),source:"preview",hoverEl:c,targetEl:c,linktext:l});return}else{console.log("DATACARDS DEBUG: Fallback to text only for pipe syntax"),t.setText(r[1]);return}}}if(i.includes("[[")&&i.includes("]]")){s.debug("Found wiki link in file property:",i);let r=i.match(/\[\[([^\]]+)\]\]/);if(r){let o=r[1],l=o,d=o;if(o.includes("|")){let g=o.split("|");d=g[0],l=g[1]}else l=this.getCleanFilename(d);let c=t.createEl("a",{cls:"internal-link datacards-file-link",text:l,attr:{href:d,"data-href":d,"data-type":"link"}});return}}else if(i.startsWith("[[")&&i.endsWith("]]")){let r=i.substring(2,i.length-2),o=r,l=r;if(r.includes("|")){let c=r.split("|");l=c[0],o=c[1]}else o=this.getCleanFilename(l);let d=t.createEl("a",{cls:"internal-link datacards-file-link",text:o,attr:{href:l,"data-href":l,"data-type":"link"}})}else{let r=this.getCleanFilename(i),o=t.createEl("a",{cls:"internal-link datacards-file-link",text:r,attr:{href:i,"data-href":i,"data-type":"link"}})}}getCleanFilename(n){let e=n;return e.includes("/")&&(e=e.split("/").pop()||e),e.endsWith(".md")&&(e=e.substring(0,e.length-3)),e}formatAsTags(n,e,t){let i=n.createEl("div",{cls:"datacards-tags-container"});(Array.isArray(e)?e:[e]).forEach(r=>{let o=r.startsWith("#")?r:`#${r}`,l=i.createEl("a",{cls:"datacards-tag tag-link",text:o,attr:{href:o,"data-href":o,"data-type":"tag"}})})}shouldUseScrollableProperties(n){let e=!1;return(n.preset==="square"||n.preset==="compact")&&(e=!0),this.pluginSettings.scrollableProperties!==void 0&&(e=this.pluginSettings.scrollableProperties),this.isMobileDevice()&&this.pluginSettings.mobileScrollableProperties!==void 0&&(e=this.pluginSettings.mobileScrollableProperties),n.scrollableProperties!==void 0&&(e=n.scrollableProperties),e}getContentHeight(n){let e="200px";return this.pluginSettings.contentHeight&&(e=this.pluginSettings.contentHeight),this.isMobileDevice()&&this.pluginSettings.mobileContentHeight&&(e=this.pluginSettings.mobileContentHeight),n.contentHeight&&(e=n.contentHeight),e}};var S=class{constructor(n){this.plugin=n}isDataviewEnabled(){return this.plugin.app.plugins.plugins.dataview!==void 0}getDataviewApi(){return this.isDataviewEnabled()?this.plugin.app.plugins.plugins.dataview.api:null}async executeQuery(n,e,t){let i=this.getDataviewApi();if(!i)return null;try{return await i.query(n,e,t)}catch(a){throw s.error("Error executing Dataview query:",a),a}}async waitForDataviewReady(){let n=this.getDataviewApi();return n?n.index&&n.index.initialized?(s.debug("Dataview index is already initialized"),!0):(s.debug("Waiting for Dataview index to be ready..."),new Promise(e=>{let t=this.plugin.app,i=t.metadataCache.on("dataview:index-ready",()=>{s.debug("Dataview index is now ready"),t.metadataCache.offref(i),e(!0)});setTimeout(()=>{s.warn("Timed out waiting for Dataview index"),t.metadataCache.offref(i),e(!1)},5e3)})):!1}async executeSafeQuery(n,e,t,i=0){let a=this.getDataviewApi();if(!a)return s.error("Dataview API not found. Make sure Dataview plugin is enabled."),{successful:!1,value:"Dataview plugin is not enabled"};if(!n||n.trim()==="")return s.error("Empty Dataview query"),{successful:!1,value:"Empty query"};s.debug("Executing Dataview query:",n),s.debug("Source path:",e);try{if(typeof a.query=="function"){s.debug("Using api.query method");try{let r=await a.query(n,e,t);return s.debug("Direct query result type:",typeof r),r==null?(s.error("Direct query returned undefined or null"),{successful:!1,value:"No results returned"}):(r&&typeof r=="object"&&("values"in r&&Array.isArray(r.values)&&s.debug("Result contains a values array with length:",r.values.length),"headers"in r&&Array.isArray(r.headers)&&s.debug("Result contains headers:",r.headers)),r&&typeof r=="object"&&"values"in r&&Array.isArray(r.values)&&r.values.length===0&&i<3?(s.debug(`Empty result, retrying (attempt ${i+1}/3)...`),new Promise(o=>{setTimeout(async()=>{let l=await this.executeSafeQuery(n,e,t,i+1);o(l)},500)})):{successful:!0,value:r})}catch(r){return s.error("Error in direct query:",r),{successful:!1,value:r?r.message||String(r):"Error in query execution"}}}else return s.error("Dataview API query method not found."),{successful:!1,value:"Incompatible Dataview API version"}}catch(r){return s.error("Error executing Dataview query:",r),{successful:!1,value:r?r.message||String(r):"Unknown error"}}}};var k=class extends b.Plugin{constructor(){super(...arguments);this.isRefreshing=!1;this.lastActiveElement=null;this.refreshDebounceTimeout=2500;this.debouncedRefresh=(0,b.debounce)(e=>{this.refreshAffectedDataCards(e)},this.refreshDebounceTimeout)}async onload(){await this.loadSettings(),s.setDebugMode(this.settings.debugMode),this.parserService=new E,this.rendererService=new C(this.app,this.settings),this.dataviewApiUtil=new S(this),this.registerMarkdownCodeBlockProcessor("datacards",this.processDataCardsBlock.bind(this)),this.addSettingTab(new D(this.app,this)),this.addCommand({id:"refresh-datacards",name:"Refresh all DataCards",callback:()=>{this.refreshAllDataCards(!0)}}),this.registerDataviewEvents(),s.debug("DataCards plugin loaded")}registerDataviewEvents(){this.app.workspace.onLayoutReady(()=>{if(!this.dataviewApiUtil.isDataviewEnabled()){s.warn("Dataview plugin is not enabled, cannot register for metadata change events");return}this.registerEvent(this.app.metadataCache.on("dataview:metadata-change",(e,t)=>{this.handleMetadataChange(e,t)})),s.debug("Registered for Dataview metadata change events")})}handleMetadataChange(e,t){if(!this.settings.enableDynamicUpdates){s.debug("Dynamic updates are disabled globally, ignoring metadata change");return}s.debug(`Dataview metadata changed: ${e} for file ${t==null?void 0:t.path}`),this.debouncedRefresh(t)}refreshAffectedDataCards(e){e&&(this.lastActiveElement=document.activeElement,this.refreshAllDataCards(!1))}onunload(){s.debug("DataCards plugin unloaded")}async loadSettings(){this.settings=Object.assign({},w,await this.loadData())}async saveSettings(){await this.saveData(this.settings),s.setDebugMode(this.settings.debugMode),this.rendererService.updateSettings(this.settings),this.refreshAllDataCards(!0)}async processDataCardsBlock(e,t,i){if(s.debug("Processing DataCards block"),!this.dataviewApiUtil.isDataviewEnabled()){s.error("Dataview plugin is not enabled"),t.createEl("div",{cls:"datacards-error",text:"Dataview plugin is required but not enabled"});return}await this.dataviewApiUtil.waitForDataviewReady()||s.warn("Timed out waiting for Dataview to be ready");try{let{query:r,settings:o}=this.parserService.parseDataCardsBlock(e);s.debug("Parsed query:",r),s.debug("Parsed settings:",o);let l=i.sourcePath,d=document.createElement("div");d.style.display="none",document.body.appendChild(d);try{s.debug("Executing Dataview query");let c=await this.dataviewApiUtil.executeSafeQuery(r,l,d);if(document.body.removeChild(d),!c){s.error("Result is undefined or null"),t.createEl("div",{cls:"datacards-error",text:"Error executing Dataview query: undefined result"});return}if(!c.successful){let p=`Error executing Dataview query: ${c.value||"unknown error"}`;s.error(p),t.createEl("div",{cls:"datacards-error",text:p});return}if(c.value&&typeof c.value=="object"&&"successful"in c.value&&c.value.successful===!1){let p=`Error executing Dataview query: ${c.value.error||"unknown error"}`;s.error(p),t.createEl("div",{cls:"datacards-error",text:p});return}if(c.value===void 0||c.value===null){s.error("Dataview returned null or undefined value"),t.createEl("div",{cls:"datacards-error",text:"Dataview returned no results. Make sure your query is correct and returns data."});return}if(Array.isArray(c.value)&&c.value.length===0){s.debug("Dataview returned empty array"),t.createEl("div",{cls:"datacards-info",text:"No files match your query criteria."});return}if(c.value.values&&Array.isArray(c.value.values)&&c.value.values.length===0){s.debug("Dataview returned empty table"),t.createEl("div",{cls:"datacards-info",text:"No files match your query criteria."});return}let g=c.value;g&&typeof g=="object"&&"successful"in g&&"value"in g&&(s.debug("Unwrapping nested result structure"),g=g.value),o.dynamicUpdate!==void 0&&s.debug(`Card has dynamicUpdate setting: ${o.dynamicUpdate}`),this.rendererService.renderCards(t,g,o)}catch(c){s.error("Error executing Dataview query:",c),document.body.contains(d)&&document.body.removeChild(d),t.createEl("div",{cls:"datacards-error",text:`Error executing Dataview query: ${c.message||String(c)}`})}}catch(r){s.error("DataCards error:",r),t.createEl("div",{cls:"datacards-error",text:`Error processing DataCards block: ${r.message||String(r)}`})}}refreshAllDataCards(e=!0){if(this.isRefreshing)return;this.isRefreshing=!0;let t=this.app.workspace.getActiveViewOfType(b.MarkdownView);t?(t.previewMode.rerender(!0),e&&new b.Notice("DataCards refreshed",2e3),setTimeout(()=>{this.lastActiveElement&&document.body.contains(this.lastActiveElement)&&this.lastActiveElement.focus(),this.isRefreshing=!1},50)):(e&&new b.Notice("No active markdown view to refresh",2e3),this.isRefreshing=!1)}};
